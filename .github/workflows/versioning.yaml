name: ë²„ì „ ê´€ë¦¬

on:
  pull_request:
    types: [closed]
    branches:
      - main

permissions:
  contents: write
  pull-requests: read

jobs:
  bump-version:
    runs-on: ubuntu-latest

    steps:
      # 1ë‹¨ê³„: ë¦¬í¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
      - name: ë¦¬í¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # ëª¨ë“  íˆìŠ¤í† ë¦¬ì™€ íƒœê·¸ë¥¼ ê°€ì ¸ì˜´

      # 2ë‹¨ê³„: Node.js ì„¤ì •
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v3
        with:
          node-version: '18' # Node.js 18 ì´ìƒìœ¼ë¡œ ì„¤ì •

      # 3ë‹¨ê³„: ì˜ì¡´ì„± ì„¤ì¹˜
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm install

      # 4ë‹¨ê³„: ìµœì‹  ì»¤ë°‹ì—ì„œ PR ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
      - name: ìµœì‹  ì»¤ë°‹ì—ì„œ PR ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
        id: get_pr_number
        uses: actions/github-script@v6
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              throw new Error('í•´ë‹¹ ì»¤ë°‹ê³¼ ì—°ê´€ëœ PRì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
            return pr.number;

      # 5ë‹¨ê³„: PR ë¼ë²¨ ê°€ì ¸ì˜¤ê¸° (ì½¤ë§ˆë¡œ êµ¬ë¶„ëœ ë¬¸ìì—´ë¡œ ë°˜í™˜)
      - name: PR ë¼ë²¨ ê°€ì ¸ì˜¤ê¸°
        id: get_labels
        uses: actions/github-script@v6
        with:
          script: |
            const prNumber = ${{ steps.get_pr_number.outputs.result }};
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });
            const labels = pr.data.labels.map(label => label.name).join(',');
            return labels;

      # 6ë‹¨ê³„: PR ë¼ë²¨ ì¶œë ¥í•˜ê¸°
      - name: PR ë¼ë²¨ ì¶œë ¥í•˜ê¸°
        run: |
          echo "PR ë¼ë²¨: ${{ steps.get_labels.outputs.result }}"

      # 7ë‹¨ê³„: ë‹¤ìŒ ë²„ì „ ê²°ì •
      - name: ë‹¤ìŒ ë²„ì „ ê²°ì •
        id: version
        run: |
          # ìµœì‹  íƒœê·¸ ê°€ì ¸ì˜¤ê¸°
          LATEST_TAG=$(git describe --tags $(git rev-list --tags --max-count=1) 2>/dev/null || echo "v0.0.0")
          echo "ìµœì‹  íƒœê·¸: $LATEST_TAG"

          # í˜„ì¬ ë²„ì „ ì¶”ì¶œ
          CURRENT_VERSION=${LATEST_TAG#v}
          echo "í˜„ì¬ ë²„ì „: $CURRENT_VERSION"

          # ë²„ì „ ë¶„í• 
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          # PR ë¼ë²¨ ê°€ì ¸ì˜¤ê¸° (ì½¤ë§ˆë¡œ êµ¬ë¶„ëœ ë¬¸ìì—´)
          LABELS="${{ steps.get_labels.outputs.result }}"
          echo "PR ë¼ë²¨: $LABELS"

          # ì½¤ë§ˆë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë°°ì—´ë¡œ ë³€í™˜
          IFS=',' read -r -a LABEL_ARRAY <<< "$LABELS"

          # ë¼ë²¨ì— ë”°ë¼ ë²„ì „ ì¦ê°€ (ìš°ì„ ìˆœìœ„: major > minor > patch)
          NEW_VERSION=""
          for label in "${LABEL_ARRAY[@]}"; do
            label=$(echo "$label" | xargs) # ê³µë°± ì œê±°
            if [[ "$label" == "ğŸ”– major" ]]; then
              NEW_MAJOR=$((MAJOR + 1))
              NEW_VERSION="$NEW_MAJOR.0.0"
              break
            elif [[ "$label" == "ğŸ”– minor" ]]; then
              NEW_MINOR=$((MINOR + 1))
              NEW_VERSION="$MAJOR.$NEW_MINOR.0"
              break
            elif [[ "$label" == "ğŸ”– patch" ]]; then
              NEW_PATCH=$((PATCH + 1))
              NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
              break
            fi
          done

          # ë¼ë²¨ì´ ì—†ê±°ë‚˜ ì¸ì‹í•  ìˆ˜ ì—†ëŠ” ê²½ìš° íŒ¨ì¹˜ ë²„ì „ ì¦ê°€
          if [[ -z "$NEW_VERSION" ]]; then
            echo "ë¼ë²¨ì´ ì§€ì •ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ íŒ¨ì¹˜ ë²„ì „ì„ ì¦ê°€ì‹œí‚µë‹ˆë‹¤."
            NEW_PATCH=$((PATCH + 1))
            NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
          fi

          echo "ìƒˆ ë²„ì „: $NEW_VERSION"

          # ì¶œë ¥ ì„¤ì •
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      # 8ë‹¨ê³„: package.json ë° manifest.config.ts ë²„ì „ ì—…ë°ì´íŠ¸
      - name: package.json ë° manifest.config.ts ë²„ì „ ì—…ë°ì´íŠ¸
        run: |
          NEW_VERSION=${{ steps.version.outputs.new_version }}
          echo "ìƒˆ ë²„ì „: $NEW_VERSION"

          # package.json ì—…ë°ì´íŠ¸
          echo "package.jsonì„ ë²„ì „ $NEW_VERSIONìœ¼ë¡œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤."
          npm version $NEW_VERSION --no-git-tag-version

          # manifest.config.ts ì—…ë°ì´íŠ¸
          echo "manifest.config.tsë¥¼ ë²„ì „ $NEW_VERSIONìœ¼ë¡œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤."
          sed -i "s/\(version: '\)[0-9]\+\.[0-9]\+\.[0-9]\+'/\1$NEW_VERSION'/" manifest.config.ts

          echo "ğŸ”„ ì—…ë°ì´íŠ¸ëœ manifest.config.ts ë‚´ìš©:"
          cat manifest.config.ts

      # 9ë‹¨ê³„: ë³€ê²½ ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
      - name: ë³€ê²½ ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json manifest.config.ts
          git commit -m "ğŸ”– chore: bump version to v${{ steps.version.outputs.new_version }}"
          git push origin main

      # 10ë‹¨ê³„: ìƒˆ íƒœê·¸ ìƒì„± ë° í‘¸ì‹œ
      - name: ìƒˆ íƒœê·¸ ìƒì„± ë° í‘¸ì‹œ
        run: |
          NEW_VERSION=${{ steps.version.outputs.new_version }}
          git tag -a v$NEW_VERSION -m "Release v$NEW_VERSION"
          git push origin v$NEW_VERSION

      # 11ë‹¨ê³„: ë¦´ë¦¬ìŠ¤ ìƒì„±
      - name: ë¦´ë¦¬ìŠ¤ ìƒì„±
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.version.outputs.new_version }}
          release_name: Release v${{ steps.version.outputs.new_version }}
          body: 'Release v${{ steps.version.outputs.new_version }}'
          draft: false
          prerelease: false
