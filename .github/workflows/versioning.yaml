name: ë²„ì „ ê´€ë¦¬

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  bump-version:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: ë¦¬í¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # ëª¨ë“  íˆìŠ¤í† ë¦¬ì™€ íƒœê·¸ë¥¼ ê°€ì ¸ì˜´

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v3
        with:
          node-version: '18' # Node.js 18 ì´ìƒìœ¼ë¡œ ì„¤ì •

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm install

      - name: PR ë¼ë²¨ ê°€ì ¸ì˜¤ê¸°
        id: get_labels
        uses: actions/github-script@v6
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
            });
            const labels = pr.data.labels.map(label => label.name);
            return JSON.stringify(labels);  // JSON ë¬¸ìì—´ë¡œ ë°˜í™˜

      - name: PR ë¼ë²¨ ì¶œë ¥í•˜ê¸°
        run: |
          echo "PR ë¼ë²¨: ${{ steps.get_labels.outputs.result }}"

      - name: ë‹¤ìŒ ë²„ì „ ê²°ì •
        id: version
        run: |
          # ìµœì‹  íƒœê·¸ ê°€ì ¸ì˜¤ê¸°
          LATEST_TAG=$(git describe --tags $(git rev-list --tags --max-count=1) 2>/dev/null || echo "v0.0.0")
          echo "ìµœì‹  íƒœê·¸: $LATEST_TAG"

          # í˜„ì¬ ë²„ì „ ì¶”ì¶œ
          CURRENT_VERSION=${LATEST_TAG#v}
          echo "í˜„ì¬ ë²„ì „: $CURRENT_VERSION"

          # ë²„ì „ ë¶„í• 
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          # PR ë¼ë²¨ ê°€ì ¸ì˜¤ê¸° (JSON ë¬¸ìì—´ì„ ë°°ì—´ë¡œ ë³€í™˜)
          LABELS=$(echo '${{ steps.get_labels.outputs.result }}' | jq -r '.[]')
          echo "PR ë¼ë²¨: $LABELS"

          # ë¼ë²¨ì— ë”°ë¼ ë²„ì „ ì¦ê°€ (ìš°ì„ ìˆœìœ„: major > minor > patch)
          if echo "$LABELS" | grep -q "ğŸ”– major"; then
            NEW_MAJOR=$((MAJOR + 1))
            NEW_VERSION="$NEW_MAJOR.0.0"
          elif echo "$LABELS" | grep -q "ğŸ”– minor"; then
            NEW_MINOR=$((MINOR + 1))
            NEW_VERSION="$MAJOR.$NEW_MINOR.0"
          elif echo "$LABELS" | grep -q "ğŸ”– patch"; then
            NEW_PATCH=$((PATCH + 1))
            NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
          else
            echo "ë¼ë²¨ì´ ì§€ì •ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ íŒ¨ì¹˜ ë²„ì „ì„ ì¦ê°€ì‹œí‚µë‹ˆë‹¤."
            NEW_PATCH=$((PATCH + 1))
            NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
          fi

          echo "ìƒˆ ë²„ì „: $NEW_VERSION"

          # ì¶œë ¥ ì„¤ì •
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: package.json ë²„ì „ ì—…ë°ì´íŠ¸
        run: |
          NEW_VERSION=${{ steps.version.outputs.new_version }}
          echo "package.jsonì„ ë²„ì „ $NEW_VERSIONìœ¼ë¡œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤."
          npm version $NEW_VERSION --no-git-tag-version
          cat package.json

      - name: ë³€ê²½ ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json
          git commit -m "ğŸ”– chore: bump version to v${{ steps.version.outputs.new_version }}"
          git push origin main

      - name: ìƒˆ íƒœê·¸ ìƒì„± ë° í‘¸ì‹œ
        run: |
          NEW_VERSION=${{ steps.version.outputs.new_version }}
          git tag -a v$NEW_VERSION -m "Release v$NEW_VERSION"
          git push origin v$NEW_VERSION

      - name: ë¦´ë¦¬ìŠ¤ ìƒì„±
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.version.outputs.new_version }}
          release_name: Release v${{ steps.version.outputs.new_version }}
          body: 'Release v${{ steps.version.outputs.new_version }}'
          draft: false
          prerelease: false
